name: Deploy
on:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    if: ${{ vars.ENABLE_DEPLOY != 'false' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node and PNPM
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '22'
          pnpm-version: '9'

      - run: pnpm install --frozen-lockfile=false

      - name: Export Cloudflare secrets to env
        run: |
          echo "CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> "$GITHUB_ENV"
          echo "CLOUDFLARE_ACCOUNT_ID=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" >> "$GITHUB_ENV"

      - name: Determine changed packages
        id: changed
        run: |
          set -euo pipefail
          BEFORE_SHA="${{ github.event.before }}"
          if [ -z "$BEFORE_SHA" ]; then
            BEFORE_SHA="$(git rev-parse HEAD^)"
          fi
          CHANGED=$(git diff --name-only "$BEFORE_SHA" "${{ github.sha }}" | grep '^src/' | cut -d/ -f2 | sort -u | tr '\n' ' ' || true)
          echo "changed=$CHANGED" >> "$GITHUB_OUTPUT"

      - name: No changes
        if: steps.changed.outputs.changed == ''
        run: echo "No worker changes detected."

      - name: Deploy changed workers
        if: steps.changed.outputs.changed != ''
        run: |
          set -euo pipefail
          for pkg in ${{ steps.changed.outputs.changed }}; do
            echo "Deploying $pkg"
            bash scripts/deploy.sh "$pkg" production
          done


